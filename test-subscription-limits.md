# サブスクリプション制限テストガイド

## テスト環境
- URL: http://localhost:3003
- 開発サーバー: ポート 3003で起動中

## テストプラン制限値
```
test プラン:
  - イベント: 3件
  - ステップ配信: 3件
  - リマインダー: 3件
  - 月間申込: 10件
```

## テスト手順

### 1. イベント作成制限のテスト ✓

1. http://localhost:3003/login にアクセス
2. ダッシュボード → 「イベント管理」
3. 「新規イベント」を3回クリックして作成
4. 4回目をクリック
5. **期待結果**: 以下のアラートが表示される
   ```
   イベント作成数の上限（3件）に達しています。

   プランをアップグレードするには、サイドバーの「サブスクリプション」をご確認ください。
   ```

### 2. ステップ配信制限のテスト ✓

1. サイドバー → 「ステップ配信設定」
2. 「メッセージを追加」を3回クリックして作成
3. 4回目をクリック
4. **期待結果**: 以下のアラートが表示される
   ```
   ステップ配信数の上限（3件）に達しています。

   プランをアップグレードするには、サイドバーの「サブスクリプション」をご確認ください。
   ```

### 3. サブスクリプションページの確認 ✓

1. サイドバー → 「サブスクリプション」
2. **期待結果**: 以下が表示される
   - 現在のプラン: テストプラン (トライアル)
   - 使用状況:
     - イベント: X / 3
     - ステップ配信: X / 3
     - リマインド: X / 3
     - 今月の申込: X / 10
   - 利用可能なプラン (モニター、正規、プロ)
   - 「このプランにアップグレード」ボタン

### 4. プランアップグレードのテスト

1. サブスクリプションページで「モニタープラン」の「このプランにアップグレード」をクリック
2. **期待結果**: Stripe Checkoutページにリダイレクトされる
   - プラン名: モニタープラン
   - 価格: ¥980/月

### 5. バックエンド制限のテスト（Cloud Functions）

リマインダーと月間申込の制限は、LINEアプリから申込を行う際に機能します。

**リマインダー制限:**
- テストプランで3件までのリマインダーが作成される
- 4件目以降は作成されない（ログに警告が出力される）

**月間申込制限:**
- テストプランで月間10件まで申込を受け付ける
- 11件目以降は403エラーが返される

## 実装済み機能一覧

### フロントエンド制限
- ✅ イベント作成前にFirestoreから組織データを取得
- ✅ events.lengthと制限値を比較
- ✅ 制限超過時にアラート表示
- ✅ ステップ配信作成前に制限チェック
- ✅ templates.lengthと制限値を比較
- ✅ 制限超過時にアラート表示

### バックエンド制限
- ✅ 申込時にcanAcceptApplication()で制限チェック
- ✅ 制限超過時は403エラー
- ✅ リマインダー作成前にcanCreateReminder()で制限チェック
- ✅ 制限超過時はリマインダーをスキップ
- ✅ 作成後にincrementReminderCount()でカウント増加

### サブスクリプション管理
- ✅ Stripe Checkoutセッション作成
- ✅ Webhook処理（決済完了、サブスクリプション更新/削除）
- ✅ プラン制限値の自動適用
- ✅ 使用状況の表示

## 制限値一覧

| プラン | イベント | ステップ配信 | リマインダー | 月間申込 | 価格 |
|--------|----------|--------------|--------------|----------|------|
| テスト | 3 | 3 | 3 | 10 | ¥0 |
| モニター | 10 | 3 | 5 | 100 | ¥980 |
| 正規 | 10 | 3 | 10 | 300 | ¥1,980 |
| プロ | 50 | 10 | 50 | 1,000 | ¥4,980 |

## トラブルシューティング

### 制限が機能しない場合
1. ブラウザのキャッシュをクリア（Ctrl+Shift+R）
2. 開発サーバーを再起動
3. Firestoreで組織データのsubscription.limitsフィールドを確認

### エラーが表示される場合
- Firestoreの組織ドキュメントにsubscriptionフィールドが存在するか確認
- 存在しない場合は管理画面から「Initialize Subscription」を実行

## コードの場所

### フロントエンド
- イベント制限: `app/dashboard/events/page.tsx:61-91`
- ステップ配信制限: `app/dashboard/step-messages/page.tsx:523-551`
- サブスクリプションページ: `app/dashboard/subscription/page.tsx`

### バックエンド
- 申込制限: `functions/src/apply-prod.ts:84-99`
- リマインダー制限: `functions/src/apply-prod.ts:129-186`
- 制限チェック関数: `functions/src/utils/admin-firestore.ts:186-221`

### 設定
- プラン定義: `lib/stripe-config.ts`
- プラン制限値: `functions/src/utils/admin-firestore.ts:374-412`
