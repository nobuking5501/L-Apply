rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isSameOrganization(orgId) {
      return isSignedIn() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId;
    }

    // Organizations - 新規作成時はorgIdがユーザーIDと一致する場合のみ許可
    match /organizations/{orgId} {
      allow read: if true; // LIFFからも読める（liffIdで検索するため）
      allow create: if isSignedIn() && orgId == 'org_' + request.auth.uid;
      allow update, delete: if isSameOrganization(orgId);
    }

    // Users - 自分のドキュメントのみ作成・読み書き可能
    match /users/{userId} {
      allow read, create, update: if isOwner(userId);
      allow delete: if false;
    }

    // Events
    match /events/{eventId} {
      allow read: if true; // LIFFからも読める
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && isSameOrganization(resource.data.organizationId);
    }

    // Applications - Cloud Functionsからもアクセス必要
    match /applications/{applicationId} {
      allow read: if true;
      allow create: if true;
      allow update, delete: if true;
    }

    // Step Deliveries - Cloud Functionsからアクセス
    match /step_deliveries/{deliveryId} {
      allow read, write: if true;
    }

    // LINE Users - Cloud Functionsからアクセス
    match /line_users/{userId} {
      allow read, write: if true;
    }

    // Reminders - Cloud Functionsからアクセス
    match /reminders/{reminderId} {
      allow read, write: if true;
    }

    // Step Message Templates - ダッシュボードとCloud Functionsからアクセス
    match /step_message_templates/{templateId} {
      allow read, write: if true;
    }

    // Consultation Requests - Cloud Functionsからアクセス
    match /consultation_requests/{requestId} {
      allow read, write: if true;
    }

    // Auto Reply Messages - ダッシュボードとCloud Functionsからアクセス
    match /auto_reply_messages/{messageId} {
      allow read, write: if true;
    }
  }
}
