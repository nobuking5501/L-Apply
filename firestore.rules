rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isSameOrganization(orgId) {
      return isSignedIn() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId;
    }

    function isAdmin() {
      return isSignedIn() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Organizations - 新規作成時はorgIdがユーザーIDと一致する場合のみ許可
    match /organizations/{orgId} {
      // Read access: Same organization members or admins
      // LIFF access is now handled via API route (/api/liff/organization)
      allow read: if isSameOrganization(orgId) || isAdmin();
      allow create: if isSignedIn() && orgId == 'org_' + request.auth.uid;
      allow update, delete: if isSameOrganization(orgId) || isAdmin();
    }

    // Organization Secrets - Server-side only (via Admin SDK)
    match /organization_secrets/{orgId} {
      allow read, write: if false; // No client-side access
    }

    // Subscriptions - 自分の組織のsubscriptionを作成・読み書き可能
    match /subscriptions/{orgId} {
      allow read: if isSameOrganization(orgId) || isAdmin();
      allow create: if isSignedIn() && orgId == 'org_' + request.auth.uid;
      allow update: if isSameOrganization(orgId) || isAdmin();
      allow delete: if false;
    }

    // Users - 自分のドキュメントのみ作成・読み書き可能
    match /users/{userId} {
      allow read: if isSignedIn(); // 管理画面用に他ユーザーも読めるように変更
      allow create, update: if isOwner(userId);
      allow delete: if false;
    }

    // Events
    match /events/{eventId} {
      allow read: if true; // LIFFからも読める
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && isSameOrganization(resource.data.organizationId);
    }

    // Applications - Cloud Functionsからもアクセス必要
    match /applications/{applicationId} {
      allow read: if true;
      allow create: if true;
      allow update, delete: if true;
    }

    // Step Deliveries - Cloud Functionsからアクセス
    match /step_deliveries/{deliveryId} {
      allow read, write: if true;
    }

    // LINE Users - Cloud Functionsからアクセス
    match /line_users/{userId} {
      allow read, write: if true;
    }

    // Reminders - Cloud Functionsからアクセス
    match /reminders/{reminderId} {
      allow read, write: if true;
    }

    // Step Message Templates - ダッシュボードとCloud Functionsからアクセス
    match /step_message_templates/{templateId} {
      allow read, write: if true;
    }

    // Reminder Message Templates - ダッシュボードとCloud Functionsからアクセス
    match /reminder_message_templates/{templateId} {
      allow read, write: if true;
    }

    // Consultation Requests - Cloud Functionsからアクセス
    match /consultation_requests/{requestId} {
      allow read, write: if true;
    }

    // Auto Reply Messages - ダッシュボードとCloud Functionsからアクセス
    match /auto_reply_messages/{messageId} {
      allow read, write: if true;
    }
  }
}
